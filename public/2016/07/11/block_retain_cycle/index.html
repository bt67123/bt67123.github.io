<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="LCJ"><meta name="description" content="什么是block循环引用如果在Block中使用附有__strong修饰符的对象类型自动变量，那么当Block从栈复制到堆时，该对象为Block所有。这样容易引起循环引用。举个简单的例子typedefvoid(^block1)(void);@interfaceView"><meta name="keywords" content=""><title>OC中block循环引用 · luocj’s blog</title><link rel="icon" href="/1493.jpg"><link rel="canonical" href="http://cnluocj.com/2016/07/11/block_retain_cycle/"><link rel="alternate" href="/atom.xml" title="luocj’s blog"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="/css/style.css"><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?Your baidu Analytics ID";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'Your Google Analytics ID', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><!--a.logo(href=url_for('.'))--><!--  = config.title--><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">OC中block循环引用</h1><span class="post-time">Jul 11, 2016</span><div id="sidebar" class="post-sidebar"><h3 class="heading">Contents</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是block循环引用"><span class="toc-text">什么是block循环引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#怎么解决循环引用"><span class="toc-text">怎么解决循环引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#对于用-weak解决block引用循环的思考"><span class="toc-text">对于用__weak解决block引用循环的思考</span></a></li></ol></div><div class="post-content"><h2 id="什么是block循环引用"><a href="#什么是block循环引用" class="headerlink" title="什么是block循环引用"></a>什么是block循环引用</h2><blockquote>
<p>如果在Block中使用附有__strong修饰符的对象类型自动变量，那么当Block从栈复制到堆时，该对象为Block所有。这样容易引起循环引用。</p>
</blockquote>
<p>举个简单的例子<br><figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^block1) (<span class="keyword">void</span>);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> () </span>&#123;</div><div class="line">    block1 _blk;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line">@implement ViewController </div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    _blk = ^ &#123;</div><div class="line">    	<span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="keyword">self</span>);</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc &#123;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>上面的例子中<code>ViewController</code>对象持有<code>_blk</code>，<code>_blk</code>持有<code>ViewController</code>对象，这样就形成了循环引用。<br>这样会导致<code>dealloc</code>无法被调用，也就是说<code>ViewContrller</code>对象无法被释放。 </p>
<a id="more"></a>
<h2 id="怎么解决循环引用"><a href="#怎么解决循环引用" class="headerlink" title="怎么解决循环引用"></a>怎么解决循环引用</h2><p>比较容易想到的是声明有<code>__weak</code>修饰符的变量，并将<code>self</code>赋值使用。<br>还是用上面那个例子</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^block1) (<span class="keyword">void</span>);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> () </span>&#123;</div><div class="line">    block1 _blk;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@implement ViewController </div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</div><div class="line">    _blk = ^ &#123;</div><div class="line">    	<span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, weakSelf);</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc &#123;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>这样就能简单解决循环引用问题了。</p>
<p>但是有时候情况没那么简单，前些天去面试，遇到了一道循环引用的改错题，题目是这样的</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> () </span>&#123;</div><div class="line">    <span class="keyword">id</span> _observer;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">     _observer = [[<span class="built_in">NSNotificationCenter</span> defaultCenter]</div><div class="line">                 addObserverForName:<span class="string">@"name"</span></div><div class="line">                 object:<span class="literal">nil</span> queue:<span class="literal">nil</span></div><div class="line">                 usingBlock:^(<span class="built_in">NSNotification</span> * _Nonnull note) &#123;</div><div class="line">                         <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="keyword">self</span>);</div><div class="line">                     &#125;);      </div><div class="line">                 &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"dealloc"</span>);</div><div class="line">    <span class="keyword">if</span> (_observer != <span class="literal">nil</span>) &#123;</div><div class="line">        [[<span class="built_in">NSNotificationCenter</span> defaultCenter] removeObserver:_observer];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>这么显而易见的错误，不就是block的循环引用吗，<code>self</code> -&gt; <code>_observer</code> -&gt; <code>block</code> -&gt; <code>self</code><br>说时迟那时快，我已把答案填好了，头也不回交卷了。我当时用的就是上面用<code>__weak</code>的解法，我的答案是这样的</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">__<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</div><div class="line">_observer = [[<span class="built_in">NSNotificationCenter</span> defaultCenter]</div><div class="line">            addObserverForName:<span class="string">@"name"</span></div><div class="line">            object:<span class="literal">nil</span> queue:<span class="literal">nil</span></div><div class="line">            usingBlock:^(<span class="built_in">NSNotification</span> * _Nonnull note) &#123;</div><div class="line">            		<span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, weakSelf);</div><div class="line">            	&#125;);      </div><div class="line">            &#125;];</div></pre></td></tr></table></figure>
<h2 id="对于用-weak解决block引用循环的思考"><a href="#对于用-weak解决block引用循环的思考" class="headerlink" title="对于用__weak解决block引用循环的思考"></a>对于用__weak解决block引用循环的思考</h2><p>上面的解决方案看上去没什么问题了，但是面试官看了答案后问，这样改会有什么问题？</p>
<p>what？exm？当时确实短路没能想到有什么问题。后来仔细想了下，循环引用确实解决了，但引入了个问题（我就想到了这个），就是如果程序走到<code>block</code>内后，如果还没完成<code>block</code>的任务<code>self</code>就被释放了，那么<code>block</code>里就没办法完成需要用到<code>self</code>的任务了。</p>
<p>假如产品需要把<code>block</code>内的任务执行完，那么上面的解法确实有点欠缺，反之，前面那种解法没什么问题。那怎么做到等到<code>block</code>走完后<code>self</code>再释放？</p>
<p>可以这样</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">__<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</div><div class="line">_observer = [[<span class="built_in">NSNotificationCenter</span> defaultCenter]</div><div class="line">            addObserverForName:<span class="string">@"name"</span></div><div class="line">            object:<span class="literal">nil</span> queue:<span class="literal">nil</span></div><div class="line">            usingBlock:^(<span class="built_in">NSNotification</span> * _Nonnull note) &#123; </div><div class="line">              		<span class="comment">// 声明一个强引用指向self</span></div><div class="line">            		<span class="keyword">typeof</span>(weakSelf) strongSelf = weakSelf;</div><div class="line">            		<span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, strongSelf);</div><div class="line">            	&#125;);      </div><div class="line">            &#125;];</div></pre></td></tr></table></figure>
<p>这样在<code>block</code>中声明一个强引用指向<code>self</code>，<code>self</code>就不会在<code>block</code>执行完之前释放，在此之前起码有一个强引用指向<code>self</code>。</p>
<p>这样会导致循环引用吗？<br>看上去有点像引用循环，<code>self</code> -&gt; <code>_observer</code> -&gt; <code>block</code> -&gt; <code>strongSelf</code><br>但由于<code>strongSelf</code>是<code>block</code>的局部变量，存储在栈内存中，所以当<code>block</code>执行完之后，超出作用域的<code>strongSelf</code>就会被释放，循环引用自然就不存在。</p>
</div></article><div class="tags"></div><div class="paginator"><a href="/2016/07/15/AVFoundation_watermark/" class="prev"><i class="iconfont icon-left"></i><span> Prev</span></a></div><section id="comments"><div data-thread-key="http://cnluocj.com/2016/07/11/block_retain_cycle/index.html" data-title="OC中block循环引用" data-url="http://cnluocj.com/2016/07/11/block_retain_cycle/index.html" class="ds-thread"></div><script type="text/javascript">var duoshuoQuery = {short_name: "bt67123" };
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></section></section><footer><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2016<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">LCJ</span></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>